<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eskul Sepak Bola - Sistem Absensi</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- QRCode Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Chart.js (Untuk Grafik) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0fdf4; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        /* Animasi Loading */
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #10b981; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // =================================================================================
        // KONFIGURASI APLIKASI
        // =================================================================================
        
        // PASTE URL GOOGLE SCRIPT ANDA DI SINI
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3lLXkfN-16qnjZkSXwwc-GbHfdzCc0-tyTzHOZSqUYPX6PdfZ2-2id2ozMKS4aRD1cw/exec"; 

        // Pengaturan Gambar & Tampilan
        const ASSETS = {
            // Background halaman utama (akan kena filter vintage)
            loginBackground: "https://github.com/racketboys-pe/abseneskulbola/blob/main/WhatsApp%20Image%202026-01-10%20at%2023.17.27.jpeg?raw=true", 
            
            // [BARU] Gambar di dalam Kotak Login (Sebelah kiri form)
            loginCardImage: "https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?q=80&w=2000&auto=format&fit=crop",

            sidebarLogo: "https://github.com/racketboys-pe/abseneskulbola/blob/main/LOGO%20ULUJAMI%20FOOTBALL.png?raw=true", 
            dashboardLogo: "https://github.com/racketboys-pe/abseneskulbola/blob/main/LOGO%20ULUJAMI%20FOOTBALL.png?raw=true",
            appName: "ESKUL Sepakbola Ulujami06"
        };

        const ADMIN_PASSWORD = "admin"; 

        // =================================================================================
        // SYSTEM LOGIC
        // =================================================================================

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getCurrentDate = () => new Date().toISOString().split('T')[0];
        const formatTime = (dateStr) => {
            if(!dateStr) return "-";
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? dateStr : date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        };

        const api = {
            async request(action, payload = {}) {
                if (GOOGLE_SCRIPT_URL) {
                    try {
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: "POST",
                            body: JSON.stringify({ action, ...payload })
                        });
                        const result = await response.json();
                        // Handle format data baru dari backend
                        if (result.status === 'success') {
                            return result.data; 
                        } else {
                            throw new Error(result.message || "Unknown error");
                        }
                    } catch (error) {
                        console.error("API Error:", error);
                        alert("Gagal terhubung ke Database Google: " + error.message);
                        return null;
                    }
                } else {
                    // Fallback LocalStorage (Offline Mode)
                    await new Promise(r => setTimeout(r, 300)); 
                    const students = JSON.parse(localStorage.getItem('eskul_students') || '[]');
                    const logs = JSON.parse(localStorage.getItem('eskul_attendance') || '[]');

                    if (action === 'GET_DATA') return { students, logs };
                    
                    if (action === 'ADD_STUDENT') {
                        const newS = { id: generateId(), ...payload };
                        localStorage.setItem('eskul_students', JSON.stringify([...students, newS]));
                        return newS;
                    }
                    if (action === 'DELETE_STUDENT') {
                        localStorage.setItem('eskul_students', JSON.stringify(students.filter(s => s.id !== payload.id)));
                        return true;
                    }
                    if (action === 'SAVE_ATTENDANCE') {
                        const newLogs = [...logs, ...payload];
                        localStorage.setItem('eskul_attendance', JSON.stringify(newLogs));
                        return true;
                    }
                }
            }
        };

        // --- HELPER UNTUK MENGHITUNG STATISTIK KELAS ---
        const calculateClassStats = (students, logs) => {
            const stats = {};
            
            // Inisialisasi map stats berdasarkan log yang ada
            logs.forEach(log => {
                const student = students.find(s => s.id === log.studentId);
                const className = (student && student.class) ? student.class : 'Tanpa Kelas';
                
                if (!stats[className]) {
                    stats[className] = { className, hadir: 0, sakit: 0, alfa: 0, total: 0 };
                }

                stats[className].total += 1;
                if (log.status === 'Hadir') stats[className].hadir += 1;
                else if (log.status === 'Sakit' || log.status === 'Izin') stats[className].sakit += 1;
                else stats[className].alfa += 1;
            });

            // Convert object to array dan sort berdasarkan nama kelas
            return Object.values(stats).sort((a, b) => a.className.localeCompare(b.className));
        };

        // --- COMPONENTS ---

        // 0. CHART COMPONENT
        const AttendanceChart = ({ stats }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current && stats.length > 0) {
                    if (chartRef.current) chartRef.current.destroy();

                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: stats.map(s => s.className),
                            datasets: [
                                {
                                    label: 'Hadir',
                                    data: stats.map(s => s.hadir),
                                    backgroundColor: '#10b981', // Emerald 500
                                    borderRadius: 4,
                                },
                                {
                                    label: 'Sakit/Izin',
                                    data: stats.map(s => s.sakit),
                                    backgroundColor: '#f59e0b', // Amber 500
                                    borderRadius: 4,
                                },
                                {
                                    label: 'Alfa',
                                    data: stats.map(s => s.alfa),
                                    backgroundColor: '#ef4444', // Red 500
                                    borderRadius: 4,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
                return () => { if(chartRef.current) chartRef.current.destroy(); }
            }, [stats]);

            if (stats.length === 0) return <div className="text-center py-10 text-gray-400">Belum ada data grafik</div>;

            return (
                <div className="relative h-64 w-full">
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        };

        // 1. LOGIN COMPONENT (UPDATED: SPLIT CARD & VINTAGE)
        const Login = ({ onLogin }) => {
            const [pass, setPass] = useState("");
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (pass === ADMIN_PASSWORD) {
                    onLogin();
                } else {
                    setError(true);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center relative overflow-hidden">
                    {/* Background Utama dengan Efek Vintage */}
                    <div 
                        className="absolute inset-0 z-0 bg-cover bg-center transition-all duration-1000"
                        style={{ 
                            backgroundImage: `url(${ASSETS.loginBackground})`,
                            filter: 'sepia(0.3) contrast(1.1) brightness(0.6)' // Vintage Filter
                        }}
                    ></div>
                    
                    {/* Layer Noise Halus untuk Tekstur Vintage (Opsional) */}
                    <div className="absolute inset-0 z-0 bg-amber-900/10 mix-blend-multiply"></div> 

                    {/* Login Card Container */}
                    <div className="relative z-10 bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col md:flex-row m-4 animate-fade-in">
                        
                        {/* Kolom Gambar (Kiri) */}
                        <div className="md:w-1/2 h-64 md:h-auto bg-cover bg-center relative group" 
                             style={{ backgroundImage: `url('${ASSETS.loginCardImage}')` }}>
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent flex flex-col justify-end p-8 transition-opacity duration-500">
                                <h2 className="text-white text-3xl font-bold tracking-tight mb-1">{ASSETS.appName}</h2>
                                <p className="text-emerald-200 text-sm font-medium tracking-wide">Grow together, Win together.</p>
                                <div className="w-12 h-1 bg-emerald-500 mt-4 rounded-full"></div>
                            </div>
                        </div>

                        {/* Kolom Form (Kanan) */}
                        <div className="md:w-1/2 p-8 md:p-12 flex flex-col justify-center bg-white">
                             <div className="text-center md:text-left mb-8">
                                <h1 className="text-2xl font-bold text-gray-800">Selamat Datang</h1>
                                <p className="text-gray-500 text-sm mt-1">Silakan masuk untuk mengakses dashboard pelatih.</p>
                             </div>

                             <form onSubmit={handleSubmit} className="space-y-5">
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-2">Password Admin</label>
                                    <input 
                                        type="password" 
                                        value={pass}
                                        onChange={(e) => { setPass(e.target.value); setError(false); }}
                                        className="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                        placeholder="••••••••"
                                    />
                                </div>
                                {error && (
                                    <div className="bg-red-50 text-red-600 text-sm py-2 px-3 rounded flex items-center gap-2 animate-pulse">
                                        <i data-lucide="alert-circle" width="16"></i> Password salah
                                    </div>
                                )}
                                <button className="w-full bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-3.5 rounded-lg shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                                    Masuk Aplikasi
                                </button>
                             </form>

                             <div className="mt-8 pt-6 border-t border-gray-100 text-center">
                                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-50 border border-gray-100">
                                    <div className={`w-2 h-2 rounded-full ${GOOGLE_SCRIPT_URL ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                                    <span className="text-[10px] uppercase font-bold text-gray-400 tracking-wider">
                                        {GOOGLE_SCRIPT_URL ? "Database Online" : "Mode Offline"}
                                    </span>
                                </div>
                                <p className="mt-4 text-xs text-gray-300 font-medium">Copyright 2026 Ryzaraccman</p>
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. DASHBOARD
        const Dashboard = ({ students, attendanceLog }) => {
            const today = getCurrentDate();
            const presentToday = attendanceLog.filter(a => a.date === today && a.status === 'Hadir').length;
            const classStats = useMemo(() => calculateClassStats(students, attendanceLog), [students, attendanceLog]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex items-center gap-3">
                        <h2 className="text-2xl font-bold text-emerald-800">Dashboard</h2>
                    </div>

                    <div className="bg-gradient-to-r from-emerald-600 to-green-500 rounded-2xl p-6 text-white shadow-xl flex items-center justify-between relative overflow-hidden">
                        <div className="z-10">
                            <h3 className="text-2xl font-bold">Selamat Datang, Coach!</h3>
                            <p className="opacity-90 mt-1">Siap memantau latihan hari ini?</p>
                        </div>
                        <img src={ASSETS.dashboardLogo} className="w-24 h-24 object-contain opacity-80 drop-shadow-lg z-10" />
                        <div className="absolute -right-4 -bottom-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
                        <div className="absolute right-20 -top-10 w-20 h-20 bg-white opacity-10 rounded-full"></div>
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow border-l-4 border-emerald-500">
                            <div className="text-gray-500 text-sm">Total Pemain</div>
                            <div className="text-3xl font-bold text-gray-800">{students.length}</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                            <div className="text-gray-500 text-sm">Hadir Hari Ini</div>
                            <div className="text-3xl font-bold text-gray-800">{presentToday}</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                                <i data-lucide="bar-chart-2" className="w-5 h-5 text-emerald-600"></i>
                                Statistik Kehadiran Per Kelas
                            </h3>
                            <AttendanceChart stats={classStats} />
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="font-semibold text-gray-700 mb-4 border-b pb-2">Log Aktivitas Terakhir</h3>
                            <div className="space-y-3 overflow-y-auto max-h-64">
                                {attendanceLog.length === 0 ? (
                                    <p className="text-gray-400 italic text-sm">Belum ada data absensi.</p>
                                ) : (
                                    attendanceLog.slice().reverse().slice(0, 6).map((log, idx) => {
                                        const student = students.find(s => s.id === log.studentId);
                                        return (
                                            <div key={idx} className="flex justify-between items-center text-sm border-b border-gray-50 pb-2 last:border-0">
                                                <div>
                                                    <div className="font-bold text-gray-700">{student ? student.name : 'Unknown'}</div>
                                                    <div className="text-xs text-gray-500">{student ? student.class : ''} • {log.date}</div>
                                                </div>
                                                <span className={`px-2 py-0.5 rounded text-xs ${log.status === 'Hadir' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {log.status}
                                                </span>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. SCANNER
        const Scanner = ({ students, onScanSuccess }) => {
            const [scanResult, setScanResult] = useState(null);
            const [isScanning, setIsScanning] = useState(false);

            useEffect(() => {
                let html5QrcodeScanner;
                if (isScanning) {
                    html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
                    html5QrcodeScanner.render((decodedText) => {
                        const student = students.find(s => s.id === decodedText);
                        if (student) {
                            setScanResult({ type: 'success', msg: `✅ ${student.name} (${student.class}) Hadir!` });
                            onScanSuccess(student.id);
                            html5QrcodeScanner.pause(true);
                            setTimeout(() => {
                                html5QrcodeScanner.resume();
                                setScanResult(null);
                            }, 2000);
                        } else {
                            setScanResult({ type: 'error', msg: '❌ QR Tidak Dikenal' });
                        }
                    }, () => {});
                }
                return () => html5QrcodeScanner?.clear().catch(() => {});
            }, [isScanning, students]);

            return (
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-emerald-800">Scan Absensi</h2>
                    <div className="bg-white p-4 rounded-xl shadow text-center">
                        {!isScanning ? (
                            <button onClick={() => setIsScanning(true)} className="bg-emerald-600 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 mx-auto hover:bg-emerald-700">
                                <i data-lucide="camera"></i> Buka Kamera
                            </button>
                        ) : (
                            <div>
                                <div id="reader" className="w-full rounded-lg overflow-hidden"></div>
                                <button onClick={() => setIsScanning(false)} className="mt-4 bg-red-500 text-white py-2 px-6 rounded-lg">Tutup Kamera</button>
                            </div>
                        )}
                        {scanResult && (
                            <div className={`mt-4 p-3 rounded-lg font-bold ${scanResult.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {scanResult.msg}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. MANUAL ATTENDANCE
        const ManualAttendance = ({ students, onSubmit }) => {
            const [selectedDate, setSelectedDate] = useState(getCurrentDate());
            const [tempAttendance, setTempAttendance] = useState({});

            const saveAll = () => {
                const logs = Object.entries(tempAttendance).map(([studentId, status]) => ({
                    studentId, status, date: selectedDate
                }));
                if(logs.length > 0) onSubmit(logs);
                setTempAttendance({});
                alert("Data berhasil disimpan!");
            };

            return (
                <div className="space-y-4">
                     <h2 className="text-2xl font-bold text-emerald-800">Absensi Manual</h2>
                     <div className="bg-white p-6 rounded-xl shadow">
                        <div className="flex items-center gap-2 mb-6 bg-gray-50 p-3 rounded-lg border">
                            <i data-lucide="calendar" className="text-emerald-600"></i>
                            <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold outline-none text-gray-700"/>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b-2 border-emerald-100">
                                    <tr>
                                        <th className="p-3">Data Pemain</th>
                                        <th className="p-3 text-center">Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {students.map(s => (
                                        <tr key={s.id} className="hover:bg-gray-50">
                                            <td className="p-3">
                                                <div className="font-bold text-gray-800">{s.name}</div>
                                                <div className="text-xs text-emerald-600 font-semibold">{s.class || 'Kelas -'}</div>
                                                <div className="text-xs text-gray-400">{s.position}</div>
                                            </td>
                                            <td className="p-3 flex justify-center items-center gap-1">
                                                {['Hadir', 'Sakit', 'Izin', 'Alfa'].map(status => (
                                                    <button key={status} onClick={() => setTempAttendance({...tempAttendance, [s.id]: status})}
                                                        className={`px-3 py-1.5 rounded text-xs font-bold transition ${
                                                            tempAttendance[s.id] === status 
                                                            ? (status === 'Hadir' ? 'bg-green-600 text-white' : status === 'Alfa' ? 'bg-red-600 text-white' : 'bg-orange-500 text-white')
                                                            : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                                        }`}
                                                    >
                                                        {status[0]}
                                                    </button>
                                                ))}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <button onClick={saveAll} className="w-full mt-6 bg-emerald-600 text-white py-3 rounded-lg font-bold shadow hover:bg-emerald-700">Simpan Absensi</button>
                     </div>
                </div>
            );
        };

        // 5. STUDENT MANAGER
        const StudentManager = ({ students, onAdd, onDelete }) => {
            const [form, setForm] = useState({ name: '', position: 'Pemain', class: '' });
            const [showQR, setShowQR] = useState(null);
            const qrRef = useRef(null);

            useEffect(() => {
                if (showQR && qrRef.current) {
                    qrRef.current.innerHTML = "";
                    new QRCode(qrRef.current, { text: showQR, width: 128, height: 128 });
                }
            }, [showQR]);

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-emerald-800">Data Pemain</h2>
                    <form onSubmit={(e) => { e.preventDefault(); if(form.name) { onAdd(form); setForm({name:'', position:'Pemain', class:''}); }}} 
                        className="bg-white p-4 rounded-xl shadow flex flex-col md:flex-row gap-2">
                        <input value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="Nama Lengkap" className="border p-2 rounded flex-1"/>
                        <input value={form.class} onChange={e=>setForm({...form, class:e.target.value})} placeholder="Kelas" className="border p-2 rounded w-24"/>
                        <select value={form.position} onChange={e=>setForm({...form, position:e.target.value})} className="border p-2 rounded">
                            <option>Pemain</option><option>Kiper</option><option>Bek</option><option>Gelandang</option><option>Penyerang</option>
                        </select>
                        <button className="bg-emerald-600 text-white px-4 py-2 rounded font-bold">+ Tambah</button>
                    </form>
                    <div className="bg-white rounded-xl shadow overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-3">Info Siswa</th>
                                    <th className="p-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {students.map(s => (
                                    <tr key={s.id} className="hover:bg-gray-50">
                                        <td className="p-3">
                                            <div className="font-bold text-gray-800">{s.name}</div>
                                            <div className="text-sm text-gray-600">
                                                <span className="bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded text-xs font-bold mr-2">{s.class || '-'}</span>
                                                <span className="text-xs">{s.position}</span>
                                            </div>
                                        </td>
                                        <td className="p-3 text-right space-x-2">
                                            <button onClick={() => setShowQR(s.id)} className="text-blue-600 text-sm hover:underline bg-blue-50 px-2 py-1 rounded">QR Code</button>
                                            <button onClick={() => onDelete(s.id)} className="text-red-600 text-sm hover:underline bg-red-50 px-2 py-1 rounded">Hapus</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {showQR && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowQR(null)}>
                            <div className="bg-white p-6 rounded-xl text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold mb-2">{students.find(s=>s.id === showQR)?.name}</h3>
                                <p className="text-sm text-gray-500 mb-4">{students.find(s=>s.id === showQR)?.class}</p>
                                <div className="bg-white p-2 inline-block border-2 border-dashed" ref={qrRef}></div>
                                <button onClick={() => setShowQR(null)} className="block w-full mt-4 text-gray-500">Tutup</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 6. REPORTS
        const Reports = ({ students, attendanceLog }) => {
            const classStats = useMemo(() => calculateClassStats(students, attendanceLog), [students, attendanceLog]);

            const downloadExcel = () => {
                const data = attendanceLog.map(log => {
                    const s = students.find(st => st.id === log.studentId);
                    return { 
                        "Tanggal": log.date, 
                        "Nama": s ? s.name : "Deleted", 
                        "Kelas": s ? s.class : "-",
                        "Posisi": s ? s.position : "-",
                        "Status": log.status, 
                        "Metode": log.method 
                    };
                });
                const ws = XLSX.utils.json_to_sheet(data);
                const ws2 = XLSX.utils.json_to_sheet(classStats); // Sheet 2: Rekap Kelas
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Log Absensi");
                XLSX.utils.book_append_sheet(wb, ws2, "Rekap Per Kelas");
                
                XLSX.writeFile(wb, "Laporan_Absensi_Lengkap.xlsx");
            };

            return (
                <div className="space-y-8">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-emerald-800">Rekapitulasi</h2>
                        <button onClick={downloadExcel} className="bg-green-700 text-white px-4 py-2 rounded shadow text-sm font-bold flex gap-2 items-center">
                            <i data-lucide="file-spreadsheet" width="16"></i> Export Excel
                        </button>
                    </div>

                    {/* SECTION 1: REKAP PER KELAS */}
                    <div className="bg-white rounded-xl shadow overflow-hidden">
                        <div className="bg-emerald-50 px-4 py-3 border-b border-emerald-100 flex items-center gap-2">
                            <i data-lucide="layers" width="18" className="text-emerald-700"></i>
                            <h3 className="font-bold text-emerald-800">Rekapitulasi Per Kelas</h3>
                        </div>
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 uppercase text-xs text-gray-600">
                                <tr>
                                    <th className="p-3">Kelas</th>
                                    <th className="p-3 text-center">Total Log</th>
                                    <th className="p-3 text-center text-green-700">Hadir</th>
                                    <th className="p-3 text-center text-orange-600">Sakit/Izin</th>
                                    <th className="p-3 text-center text-red-600">Alfa</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {classStats.length === 0 ? (
                                    <tr><td colSpan="5" className="p-4 text-center text-gray-400">Belum ada data absensi.</td></tr>
                                ) : (
                                    classStats.map((stat, i) => (
                                        <tr key={i} className="hover:bg-gray-50">
                                            <td className="p-3 font-bold text-gray-800">{stat.className}</td>
                                            <td className="p-3 text-center font-bold">{stat.total}</td>
                                            <td className="p-3 text-center bg-green-50 text-green-800 font-semibold">{stat.hadir}</td>
                                            <td className="p-3 text-center text-orange-600">{stat.sakit}</td>
                                            <td className="p-3 text-center text-red-600">{stat.alfa}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* SECTION 2: LOG DETAIL */}
                    <div className="bg-white rounded-xl shadow overflow-hidden">
                        <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex items-center gap-2">
                            <i data-lucide="list" width="18" className="text-gray-600"></i>
                            <h3 className="font-bold text-gray-700">Log Aktivitas Detail</h3>
                        </div>
                        <div className="overflow-x-auto max-h-96">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 uppercase text-xs text-gray-600 sticky top-0">
                                    <tr>
                                        <th className="p-3">Tgl</th>
                                        <th className="p-3">Nama/Kelas</th>
                                        <th className="p-3">Status</th>
                                        <th className="p-3">Metode</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {attendanceLog.slice().reverse().map((log, i) => {
                                        const s = students.find(st => st.id === log.studentId);
                                        return <tr key={i}>
                                            <td className="p-3 text-gray-500">{log.date}</td>
                                            <td className="p-3">
                                                <div className="font-medium text-gray-900">{s ? s.name : 'Unknown'}</div>
                                                <div className="text-xs text-gray-500">{s ? s.class : ''}</div>
                                            </td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${log.status === 'Hadir' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>{log.status}</span></td>
                                            <td className="p-3 text-xs text-gray-400">{log.method}</td>
                                        </tr>
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ROOT APP ---
        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [view, setView] = useState('dashboard');
            const [students, setStudents] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (isLoggedIn) {
                    loadData();
                    if (window.lucide) window.lucide.createIcons();
                }
            }, [isLoggedIn, view]);

            const loadData = async () => {
                setLoading(true);
                const data = await api.request('GET_DATA');
                if (data) {
                    setStudents(data.students || []);
                    setLogs(data.logs || []);
                }
                setLoading(false);
            };

            const handleAddStudent = async (studentData) => {
                setLoading(true);
                const result = await api.request('ADD_STUDENT', studentData);
                if (result) await loadData();
                setLoading(false);
            };

            const handleDeleteStudent = async (id) => {
                if(!confirm("Hapus data siswa ini?")) return;
                setLoading(true);
                await api.request('DELETE_STUDENT', { id });
                await loadData();
                setLoading(false);
            };

            const handleAttendance = async (dataArray) => {
                const enriched = dataArray.map(d => ({
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    method: 'Manual',
                    ...d
                }));
                setLogs([...logs, ...enriched]);
                await api.request('SAVE_ATTENDANCE', enriched);
            };

            const handleScan = async (studentId) => {
                const today = getCurrentDate();
                const exists = logs.some(l => l.studentId === studentId && l.date === today);
                if (exists) return;

                const payload = [{
                    id: generateId(), studentId, date: today, status: 'Hadir', method: 'Scan', timestamp: new Date().toISOString()
                }];
                setLogs([...logs, ...payload]);
                await api.request('SAVE_ATTENDANCE', payload);
            };

            if (!isLoggedIn) return <Login onLogin={() => setIsLoggedIn(true)} />;

            return (
                <div className="flex flex-col md:flex-row h-screen bg-emerald-50 text-gray-800 font-sans">
                    {/* Sidebar */}
                    <nav className="bg-white md:w-64 flex-shrink-0 flex md:flex-col justify-between p-4 shadow-xl z-20 sticky top-0 md:relative border-r border-emerald-100">
                        <div className="flex items-center gap-3 mb-0 md:mb-8">
                            <img src={ASSETS.sidebarLogo} className="w-10 h-10 object-contain bg-emerald-100 rounded-lg p-1" alt="Logo" />
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-emerald-900">{ASSETS.appName}</h1>
                                <p className="text-xs text-gray-500">Admin Panel</p>
                            </div>
                        </div>

                        <div className="flex md:flex-col gap-2 overflow-x-auto md:overflow-visible w-full no-scrollbar">
                            {[
                                { id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard' },
                                { id: 'scan', icon: 'qr-code', label: 'Scan Mode' },
                                { id: 'manual', icon: 'clipboard-check', label: 'Input Manual' },
                                { id: 'students', icon: 'users', label: 'Data Pemain' },
                                { id: 'reports', icon: 'bar-chart-3', label: 'Laporan' },
                            ].map(menu => (
                                <button key={menu.id} onClick={() => setView(menu.id)}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium text-sm whitespace-nowrap ${
                                        view === menu.id ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-200' : 'text-gray-600 hover:bg-emerald-50'
                                    }`}
                                >
                                    <i data-lucide={menu.icon} width="18"></i>
                                    <span className="hidden md:inline">{menu.label}</span>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setIsLoggedIn(false)} className="hidden md:flex mt-auto items-center gap-2 text-red-500 text-sm px-4 py-2 hover:bg-red-50 rounded-lg transition">
                            <i data-lucide="log-out" width="16"></i> Logout
                        </button>
                    </nav>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto relative">
                        {loading && (
                            <div className="absolute inset-0 bg-white/50 backdrop-blur-sm z-50 flex items-center justify-center">
                                <div className="spinner"></div>
                            </div>
                        )}
                        <div className="max-w-4xl mx-auto p-4 md:p-8 pb-20">
                            {view === 'dashboard' && <Dashboard students={students} attendanceLog={logs} />}
                            {view === 'scan' && <Scanner students={students} onScanSuccess={handleScan} />}
                            {view === 'manual' && <ManualAttendance students={students} onSubmit={handleAttendance} />}
                            {view === 'students' && <StudentManager students={students} onAdd={handleAddStudent} onDelete={handleDeleteStudent} />}
                            {view === 'reports' && <Reports students={students} attendanceLog={logs} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

